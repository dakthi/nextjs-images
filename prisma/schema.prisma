generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// BRANDS
// ============================================
model Brand {
  id        String    @id @default(uuid())
  name      String    @unique
  slug      String    @unique
  description String?
  logoUrl   String?   @map("logo_url")
  products  Product[]
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@map("brands")
}

// ============================================
// PRODUCTS
// ============================================
model Product {
  id          String           @id @default(uuid())
  brandId     String           @map("brand_id")
  brand       Brand            @relation(fields: [brandId], references: [id])
  productCode String           @unique @map("product_code")
  name        String
  slug        String           @unique
  isActive    Boolean          @default(true) @map("is_active")
  versions    ProductVersion[]
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  @@index([brandId])
  @@index([productCode])
  @@index([isActive])
  @@index([slug])
  @@map("products")
}

// ============================================
// PRODUCT VERSIONS (for tracking changes)
// ============================================
model ProductVersion {
  id            String            @id @default(uuid())
  productId     String            @map("product_id")
  product       Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  versionNumber Int               @map("version_number")
  versionName   String?           @map("version_name")
  isCurrent     Boolean           @default(true) @map("is_current")
  description   String?
  createdBy     String            @map("created_by")
  createdAt     DateTime          @default(now()) @map("created_at")

  contents      ProductContent[]
  images        ProductImage[]
  properties    ProductProperty[]
  pricing       Pricing[]
  imageUsage    ImageUsage[]

  @@index([productId])
  @@index([isCurrent])
  @@map("product_versions")
}

// ============================================
// PRODUCT CONTENT (multiple descriptions)
// ============================================
model ProductContent {
  id          String         @id @default(uuid())
  versionId   String         @map("version_id")
  version     ProductVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  contentType String         @map("content_type")
  content     String         @db.Text
  language    String         @default("en")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  @@index([versionId])
  @@index([contentType])
  @@map("product_content")
}

// ============================================
// PRODUCT IMAGES
// ============================================
model ProductImage {
  id           String         @id @default(uuid())
  versionId    String         @map("version_id")
  version      ProductVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  imageUrl     String         @map("image_url")
  imageType    String         @map("image_type")
  position     String?
  displayOrder Int            @default(0) @map("display_order")
  altText      String?        @map("alt_text")
  label        String?
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  @@index([versionId])
  @@index([imageType])
  @@unique([versionId, position], name: "unique_version_position")
  @@map("product_images")
}

// ============================================
// PRODUCT PROPERTIES (flexible key-value)
// ============================================
model ProductProperty {
  id            String         @id @default(uuid())
  versionId     String         @map("version_id")
  version       ProductVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  propertyKey   String         @map("property_key")
  propertyValue String         @map("property_value")
  displayOrder  Int            @default(0) @map("display_order")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  @@index([versionId])
  @@index([propertyKey])
  @@map("product_properties")
}

// ============================================
// PRICING
// ============================================
model Pricing {
  id            String         @id @default(uuid())
  versionId     String         @map("version_id")
  version       ProductVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  size          String
  price         Decimal        @db.Decimal(10, 2)
  currency      String         @default("GBP")
  condition     String?
  discountPrice Decimal?       @map("discount_price") @db.Decimal(10, 2)
  discountLabel String?        @map("discount_label")
  displayOrder  Int            @default(0) @map("display_order")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  @@index([versionId])
  @@map("pricing")
}

// ============================================
// SALES TEMPLATES (for rendering cards)
// ============================================
model SalesTemplate {
  id             String           @id @default(uuid())
  name           String
  description    String?
  templateConfig Json             @map("template_config")
  htmlTemplate   String?          @map("html_template") @db.Text
  previewUrl     String?          @map("preview_url")
  isActive       Boolean          @default(true) @map("is_active")
  renders        TemplateRender[]
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  @@map("sales_templates")
}

// ============================================
// TEMPLATE RENDERS (export history)
// ============================================
model TemplateRender {
  id           String        @id @default(uuid())
  templateId   String        @map("template_id")
  template     SalesTemplate @relation(fields: [templateId], references: [id])
  productIds   String[]      @map("product_ids")
  renderConfig Json          @map("render_config")
  outputFormat String        @map("output_format")
  outputUrl    String?       @map("output_url")
  status       String        @default("pending")
  createdBy    String        @map("created_by")
  createdAt    DateTime      @default(now()) @map("created_at")

  @@index([templateId])
  @@index([status])
  @@map("template_renders")
}

// ============================================
// SHARED IMAGES (images used by multiple products)
// ============================================
model SharedImage {
  id         String       @id @default(uuid())
  imageUrl   String       @unique @map("image_url")
  imageType  String       @map("image_type")
  tags       String[]
  usedCount  Int          @default(0) @map("used_count")
  imageUsage ImageUsage[]
  createdAt  DateTime     @default(now()) @map("created_at")

  @@index([imageType])
  @@map("shared_images")
}

// ============================================
// IMAGE USAGE (many-to-many: shared images <-> product versions)
// ============================================
model ImageUsage {
  id            String         @id @default(uuid())
  sharedImageId String         @map("shared_image_id")
  sharedImage   SharedImage    @relation(fields: [sharedImageId], references: [id])
  versionId     String         @map("version_id")
  version       ProductVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  position      String?
  createdAt     DateTime       @default(now()) @map("created_at")

  @@index([sharedImageId])
  @@index([versionId])
  @@map("image_usage")
}

// ============================================
// AUDIT LOG (track all changes)
// ============================================
model AuditLog {
  id           String   @id @default(uuid())
  entityType   String   @map("entity_type")
  entityId     String   @map("entity_id")
  action       String
  changes      Json?
  performedBy  String   @map("performed_by")
  ipAddress    String?  @map("ip_address")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
  @@map("audit_log")
}
